<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Health Manager</title>

    <link href="/stylesheets/master.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/all.js" type="text/javascript"></script>
    <link href='/images/favicon.ico' rel='shortcut icon'>
    <script type="text/javascript">
      $(document).ready(function(){
        $('a#search').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 20px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2').css("padding","11px 10px 8px");
          $('#search-on').show();
          $('#search-off').hide();
        });
        $('.cancel-x').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 63px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2, #organization_bar .navbar .nav>li a#search').css("padding","16px 20px 15px");
          $('#organization_bar .navbar .nav>li a#getinvolved').css("padding","11px 92px 8px");
          $('#organization_bar .navbar .nav>li#docs-off .docs-list-list a').css("padding","0");
          $('#search-on').hide();
          $('#search-off').show();
        });f
        $(".togglebutton").click(function () {
        var divname= this.value;
          $("#"+divname).show("slow").siblings().hide("slow");
        });
      });
    </script>

    <!--[if lt IE 9]>
    <style>
        #content .container-full {background:  #ebf0fa;}
        .call-to-contribute-box, .column-left, .column-middle, .column-right {background:#e3e8f2}
        #footer {background:#000;}
    </style>
    <![endif]-->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-22181585-1']);
      _gaq.push(['_setDomainName', 'cloudfoundry.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body class="docs docs_running docs_running_architecture docs_running_architecture_health-manager">
    <img id="bg" src="/images/bg-plain-x.jpg">
    <div id='non_footer'>
      <div id='header'>
        <div class='container_wide'>
          <ul class='actions'>
            <li class='last'>
              <a href="http://www.cloudfoundry.com/contact">Contact Us</a>
            </li>
            <li>
              <a class='register_link' href='http://login.run.pivotal.io/login'>My Account</a>            
            </li>
          </ul>
        </div>
      </div>
      <div id='content'>
        <div class='logo-main'>
          <div class='logo'>
            <a href='http://www.cloudfoundry.com'>
            <img src='/images/logo-cloudfoundry.png'>
            </a>
            <a href='http://www.gopivotal.com' target="_blank">
            <img id="pivotal-logo" src='/images/logo-pivotal.png'>
            </a>
          </div>
          <div class='cta'>
            <a href='https://console.run.pivotal.io'>
            <img src='/images/signup_freetrial.png'>
            </a>
          </div>
        </div><!-- End of logo-main-->
        <div class='container-full'>
          <div id='organization_bar'>
            <div class='navbar'>
              <ul class='nav'>
                <li>
                <a href='http://www.cloudfoundry.com/use' id='use'>Using Cloud Foundry</a>
                </li>
                <li>
                <a href='http://www.cloudfoundry.com/run' id='run'>Running Cloud Foundry</a>
                </li>
                <li>
                <a href='http://www.cloudfoundry.com/getinvolved' id='getinvolved'>Get Involved</a>
                </li>
                <li id='docs-off'>
                  <a href='/' id='docs'>
                    <div id='icon-docs'></div>
                  </a>
                  <div id='docs-list'>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/using/app-arch/'>Using Cloud Foundry</a>
                      <br>
                      <a href="/docs/using/app-arch/">Application Architecture Considerations</a>
                      <br>
                      <a href='/docs/using/deploying-apps/'>Deploying Apps</a>
                      <br>
                      <a href='/docs/using/managing-apps/'>Managing Apps</a>
                      <br>
                      <a href='/docs/using/services.html'>Using Services</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/using/">See all</a>
                    </div><!-- End of 1st column docs-list-list-->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/running/'>Running Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/architecture/'>Architecture</a>
                      <br>
                      <a href='/docs/running/bosh/'>BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf/'>Deploying with BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf-with-chef/'>Deploying with Chef</a>
                      <br>
                      <a href='/docs/running/micro_cloud_foundry/'>Micro Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/managing-cf/index.html'>Managing Cloud Foundry</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/running/">See all</a>
                    </div><!-- End of column 2 docs-list-list -->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/reference/'>Reference</a>
                      <br>
                      <a href='/docs/reference/cc-api.html'>Cloud Foundry REST API</a>
                      <br>
                      <a class="docs-list-th" href='/docs/dotcom/'>CloudFoundry.com</a>
                      <br>
                      <a href='/docs/dotcom/integration/'>Technical Integration</a>
                      <br>
                      <a class="docs-list-th" href='/docs/community/'>Community</a>
                    </div><!-- End of column 3 docs-list-list -->
                  </div><!-- End of docs-list -->
                </li>
                <li id='search-off'>
                  <a id='search'>
                    <div class='icon-search'></div>
                  </a>
                </li>
                <li id='search-on'>
                  <a id='search2'>
                    <form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
                      <input autocomplete='off' class='search-input' id='search-query' name='q' onfocus="this.placeholder = ''" placeholder='' type='search' value=''>
                    </form>
                    <div class="cancel-x"></div>
                  </a>
                </li>
              </ul>
            </div><!-- End of navbar -->
          </div><!-- End of organization_bar -->
          <div class='content_inner'>
            <a class="forkme" href="http://github.com/cloudfoundry/cf-docs" target="_blank">
              <img alt="Fork me on GitHub" src="/images/ribbon_forkme.png">
            </a>
            <form action='http://www.cloudfoundry.com/search' class='search-docs-form' method='get' onsubmit='return submitQuery()'>
              <input autocomplete='off' class='search-docs-input' id='search-query' name='q' onfocus="this.placeholder = 'more:docs '" placeholder='' type='search-docs' value='more:docs '>
            </form>
            <br clear="left">
            
              <div class="breadcrumbs">
                <ul>
                  <li>
                    <a href="/">Home</a>
                  </li>
                  <li class=""><a href="/docs/running/">Running Cloud Foundry</a></li> <li class=""><a href="/docs/running/architecture/">Architecture</a></li> <li class="active"><span>Health Manager</span></li>
                </ul>
              </div>
              <br clear="left">

			

              <div class="quick-links"><ul>
<li><a href="#components">Health Manager Components</a></li>
<li><a href="#harmonization">Harmonization Policy</a>

<ul>
<li><a href="#droplet-exited">Handling droplet exited Messages</a></li>
<li><a href="#flapping-instances">Handling Flapping Instances</a></li>
<li><a href="#heartbeat-processing">Heartbeat Processing</a></li>
</ul></li>
<li><a href="#configuration">Health Manager Configuration</a></li>
<li><a href="#logging">Heatlh Manager Logging</a></li>
</ul>
</div>

              <h1>Health Manager</h1>

            
            <p>Health Manager has four core responsibilities:</p>

<ul>
<li>Monitor applications to determine their state (e.g. running, stopped, crashed, etc.), version, and number of instances. The actual state of an application is updated  based on heartbeats and <code>droplet.exited</code> messages issued by the DEA running the application.</li>
<li>Determine applications&#39; expected state, version, and number of instances. The desired state of an application is obtained from a dump of the Cloud Controller database.</li>
<li>Reconcile the actual state of applications with their expected state. For instance, if fewer than expected instances are running, the Health Manager will instruct the Cloud Controller to start the appropriate number of instances.</li>
<li>Direct Cloud Controller to take action to correct any discrepancies in the state of applications.</li>
</ul>

<p>The Health Manager is essential to ensuring that apps running on Cloud Foundry remain available. It is needed to restart applications whenever the DEA running an app shuts down for any reason; Warden kills the app because it violated a quota; or the application process exits with a non-zero exit code.</p>

<h2><a id='components'></a>Health Manager Components</h2>

<p>This section describes Health Manager components.</p>

<ul>
<li>Manager &mdash; The Manager component provides an entry point and configures, initializes and registers other Health Manager components.</li>
<li>Harmonizer &mdash; The Harmonizer periodically compares the actual state of an application to the desired state; the Scheduler and Nudger actions are used to bring the states into harmony.</li>
<li>Scheduler &mdash; The Scheduler encapsulates Ruby EventMachine-related functionality such as timer setup and cancellation, and quantization of long-running tasks to prevent EventMachine Reactor loop blocking.</li>
<li>Desired State &mdash; The Desired State component obtains the expected state of the application: stopped or started, how many instances should be running, and so on, from the <a href="/docs/running/architecture/cloud-controller.html">Cloud Controller</a> via the HTTP-based Bulk API. The Bulk API returns a dump of the CC_DB database, which contains the Cloud Controller&#39;s expected state for all applications.</li>
<li>Actual State &mdash; The Actual State component listens to heartbeat and other messages on the <a href="/docs/running/architecture/messaging-nats.html">NATS</a> bus from DEAs.</li>
<li>Nudger &mdash; Nudger is the interface that the Health Manager uses to remedy discrepancies between desired and actual application state by dispatching <code>health.start</code> and <code>health.stop</code> messages that instruct Cloud Controller to start or stop instances. Nudger maintains a priority queue of these requests, and dequeues the messages by a batchful.</li>
<li>Reporter &mdash; The Reporter responds to <code>healthmanager.status</code> and <code>healthmanager.health</code> requests and reports on the actual state of the world.</li>
</ul>

<h2><a id='harmonization'></a>Harmonization Policy</h2>

<p>Conceptually, harmonization happens in two ways:</p>

<ul>
<li>By reacting to messages (such as <code>droplet.exited</code>)</li>
<li>By periodically scanning the world and enumerating applications, looking for anomalies.</li>
</ul>

<h3><a id='droplet-exited'></a>Handling droplet exited Messages</h3>

<p>There are three scenarios that result in a <code>droplet.exited</code> message:</p>

<ul>
<li>An  application was stopped explicitly, in which case no remedial action is required.</li>
<li>A DEA is being evacuated and all application instances running there need to be restarted somewhere else. Health Manager initiates the restarts.</li>
<li>An application instance crashed. The crashed instance needs to be restarted, unless it crashed multiple times within a short period of time, in which case it is declared <code>flapping</code>. See the following section for more information.</li>
</ul>

<h3><a id='flapping-instances'></a>Handling Flapping Instances</h3>

<p>An instance of application is declared &ldquo;flapping&rdquo; if it crashed more than <code>flapping_death</code> times within <code>flapping_timeout</code> seconds. There are several possible reasons for flapping:</p>

<ul>
<li>The application is completely broken and will not start.</li>
<li>The application has a bug that results in repeated crashes.</li>
<li>The application depends on an external or Cloud Foundry-provisioned service that is unavailable, resulting in repeated crashes.</li>
</ul>

<p>The goals for handling a flapping application are:</p>

<ul>
<li>Attempt to restart an application when appropriate.</li>
<li>Provide crashlogs for crashed instances.</li>
<li>Reduce the overhead associated with restarting an application, particularly the overhead associated with moving application bits to the DEA.</li>
<li>Avoid IO spikes due to massive simultaneous restarts.</li>
</ul>

<p>To accommodate these conflicting requirements, the policy for handling a flapping instance is:</p>

<ul>
<li>Initially restart the instance with a delay defined by <code>min_restart_delay</code>.</li>
<li>For each subsequent crash, double the delay up to the value of <code>max_restart_delay</code>.</li>
<li>Add a random noise to the value of delay, its maximum absolute value defined by <code>delay_time_noise</code>.</li>
<li>If the number of crashes for flapping instance exceeds <code>giveup_crash_number</code>, stop trying to restart the instance. This behavior can be disabled.</li>
</ul>

<h3><a id='heartbeat-processing'></a>Heartbeat Processing</h3>

<p>DEAs periodically issue heartbeat messages on the NATS bus. A heartbeat message identifies the issuing DEA and includes information about application instances running on the DEA.</p>

<p>The heartbeats are used to establish whether there are &ldquo;missing&rdquo; or &ldquo;extra&rdquo; instances.</p>

<p>An instance is &ldquo;missing&rdquo; if its heartbeat has not been received in the last <code>droplet_lost</code> seconds. However, an <code>instance_missing</code> event is triggered only if the desired state has been fetched and is up-to-date.</p>

<p>An <code>instance_missing</code> event triggers a start command. A stop command is triggered for each extra instance.</p>

<h2><a id='configuration'></a>Health Manager Configuration</h2>

<p>The Health Manager is configured in the <code>health_manager.yml</code> file. See <a href="https://github.com/cloudfoundry/health_manager/blob/master/config/health_manager.yml">example config file</a> for an explanation of all the configurable variables.</p>

<h2><a id='logging'></a>Heatlh Manager Logging</h2>

<p>Health Manager uses <a href="http://github.com/cloudfoundry/steno">Steno</a> to manage its logs. The <code>logging</code> key in <code>health_manager.yml</code> specifies the log level. The table below lists and defines log levels; the right-hand column provides examples of occurrences associated with a log level.:</p>

<table><thead>
<tr>
<th align="left">Log Level</th>
<th align="left">Description</th>
<th align="left">Example Events</th>
</tr>
</thead><tbody>
<tr>
<td align="left">error</td>
<td align="left">Situation that might need corrective action.</td>
<td align="left">Health Manager received an error response from the Cloud Controller bulk API.</td>
</tr>
<tr>
<td align="left">warn</td>
<td align="left">Situation that might result in an error.</td>
<td align="left">A droplet analysis was initiated while the previous droplet analysis was still running.</td>
</tr>
<tr>
<td align="left">info</td>
<td align="left">Records a completed action or the current state of a component.</td>
<td align="left">Health Manager registered a new component; Health Manager is shutting down.</td>
</tr>
<tr>
<td align="left">debug</td>
<td align="left">Records steps in a complex task.</td>
<td align="left">Health Manager starts or stops an instance.</td>
</tr>
<tr>
<td align="left">debug2</td>
<td align="left">Records steps in a complex task at a granular level of detail.</td>
<td align="left">Health Manager received a heartbeat from a DEA; Health Manager compares an application&#39;s desired and known states.</td>
</tr>
</tbody></table>

          </div><!-- End of content_inner -->
        </div><!-- End of container-full -->
      </div><!-- End of content -->
    </div><!-- End of non_footer -->
    <div id='footer'>
      <div id='container-footer'>
        <div class='bg_social'>
          <ul class='social'>
            <li>
            <a href='http://twitter.com/cloudfoundry' target='_blank'>
            <img alt='Twitter' src='/images/twitter_large.png'>
            </a>
            </li>
            <li>
            <a href='https://plus.google.com/114245065906861739918/posts' target='_blank'>
            <img alt='Google+' src='/images/g+_large.png'>
            </a>
            </li>
            <li>
            <a href='http://facebook.com/cloudfoundry' target='_blank'>
            <img alt='Facebook' src='/images/facebook_large.png'>
            </a>
            </li>
            <li>
            <a href='http://youtube.com/cloudfoundry' target='_blank'>
            <img alt='Youtube' src='/images/youtube_large.png'>
            </a>
            </li>
          </ul>
        </div><!-- End of bg_social -->
        <ul class='links'>
          <li>
          <a href='http://www.cloudfoundry.com/about'>About</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://blog.cloudfoundry.com/'>Blog</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/partners'>Partners</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://docs.cloudfoundry.com'>Docs</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/faq'>FAQ</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/getinvolved'>Get Involved</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://status.cloudfoundry.com/'>Status</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/support'>Support</a>
          </li>
        </ul>
        <div class='copyright'>
          <div class='hr-horizontal-dark'></div>
          <br>
          <p>
            &copy;
            <script>
              //<![CDATA[
                var d = new Date();
                document.write(d.getFullYear());
              //]]>
            </script>
            GoPivotal, Inc. All rights reserved.
            <a href='http://www.cloudfoundry.com/terms'>Terms</a>
            <a href='http://www.gopivotal.com/privacy-policy' target='_blank'>Privacy</a>
          </p>
        </div><!-- End of copyright -->
      </div><!-- End of container-footer -->
    </div><!-- End of footer -->
    <script type="text/javascript">
      (function() {
        var didInit = false;
        function initMunchkin() {
          if(didInit === false) {
            didInit = true;
            Munchkin.init('625-IUJ-009');
          }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function() {
          if (this.readyState == 'complete' || this.readyState == 'loaded') {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
      })();
    </script>
  </body>
</html>
