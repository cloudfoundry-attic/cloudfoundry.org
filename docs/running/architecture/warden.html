<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Warden</title>

    <link href="/stylesheets/master.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/all.js" type="text/javascript"></script>
    <link href='/images/favicon.ico' rel='shortcut icon'>
    <script type="text/javascript">
      $(document).ready(function(){
        $('a#search').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 20px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2').css("padding","11px 10px 8px");
          $('#search-on').show();
          $('#search-off').hide();
        });
        $('.cancel-x').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 63px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2, #organization_bar .navbar .nav>li a#search').css("padding","16px 20px 15px");
          $('#organization_bar .navbar .nav>li a#getinvolved').css("padding","11px 92px 8px");
          $('#organization_bar .navbar .nav>li#docs-off .docs-list-list a').css("padding","0");
          $('#search-on').hide();
          $('#search-off').show();
        });f
        $(".togglebutton").click(function () {
        var divname= this.value;
          $("#"+divname).show("slow").siblings().hide("slow");
        });
      });
    </script>

    <!--[if lt IE 9]>
    <style>
        #content .container-full {background:  #ebf0fa;}
        .call-to-contribute-box, .column-left, .column-middle, .column-right {background:#e3e8f2}
        #footer {background:#000;}
    </style>
    <![endif]-->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-22181585-1']);
      _gaq.push(['_setDomainName', 'cloudfoundry.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body class="docs docs_running docs_running_architecture docs_running_architecture_warden">
    <img id="bg" src="/images/bg-plain-x.jpg">
    <div id='non_footer'>
      <div id='content'>
            <div class="text-center" style="background: url(/images/bg-crowd.png);background-position:center bottom;background-repeat:no-repeat">
                <img src="/images/logo_org.png">
            </div>
          <br></br>
        <div class='container-full'>
          <div id='organization_bar'>
            <div class='navbar'>
              <ul class='nav'>
                            <li id='icon-home-li'>
                                <a id='icon-home-link' href='/'>
                                    <img id='icon-home' src='http://blog.cloudfoundry.com/wp-content/static/cforg/img/icon-home.png'>
                                </a>
                            </li>
                            <li>
                                <a id='about' href='http://www.cloudfoundry.org/about.html'>About</a>
                            </li>
                            <li>
                                <a id='learn' href='http://www.cloudfoundry.org/learn.html'>Learn</a>
                            </li>
                            <li>
                                <a href='http://www.cloudfoundry.org/documentation.html'>Documentation</a>
                            </li>
                            <li>
                                <a id='get-involved' href='http://www.cloudfoundry.org/getinvolved.html'>Get Involved</a>
                            </li>

                <li id='docs-off'>
                    <!--
                  <a href='/' id='docs'>
                    <div id='icon-docs'></div>
                  </a>
                     -->
                  <div id='docs-list'>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/using/app-arch/'>Using Cloud Foundry</a>
                      <br>
                      <a href="/docs/using/app-arch/">Application Architecture Considerations</a>
                      <br>
                      <a href='/docs/using/deploying-apps/'>Deploying Apps</a>
                      <br>
                      <a href='/docs/using/managing-apps/'>Managing Apps</a>
                      <br>
                      <a href='/docs/using/services.html'>Using Services</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/using/">See all</a>
                    </div><!-- End of 1st column docs-list-list-->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/running/'>Running Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/architecture/'>Architecture</a>
                      <br>
                      <a href='/docs/running/bosh/'>BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf/'>Deploying with BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf-with-chef/'>Deploying with Chef</a>
                      <br>
                      <a href='/docs/running/micro_cloud_foundry/'>Micro Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/managing-cf/index.html'>Managing Cloud Foundry</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/running/">See all</a>
                    </div><!-- End of column 2 docs-list-list -->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/reference/'>Reference</a>
                      <br>
                      <a href='/docs/reference/cc-api.html'>Cloud Foundry REST API</a>
                      <br>
                      <a class="docs-list-th" href='/docs/dotcom/'>CloudFoundry.com</a>
                      <br>
                      <a href='/docs/dotcom/integration/'>Technical Integration</a>
                      <br>
                      <a class="docs-list-th" href='/docs/community/'>Community</a>
                    </div><!-- End of column 3 docs-list-list -->
                  </div><!-- End of docs-list -->
                </li>
                  <!--
                <li id='search-off'>
                  <a id='search'>
                    <div class='icon-search'></div>
                  </a>
                </li>
                <li id='search-on'>
                  <a id='search2'>
                    <form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
                      <input autocomplete='off' class='search-input' id='search-query' name='q' onfocus="this.placeholder = ''" placeholder='' type='search' value=''>
                    </form>
                    <div class="cancel-x"></div>
                  </a>
                </li>
                  -->
              </ul>
            </div><!-- End of navbar -->
          </div><!-- End of organization_bar -->
          <div class='content_inner'>
            <a class="forkme" href="http://github.com/cloudfoundry/cf-docs" target="_blank">
              <img alt="Fork me on GitHub" src="/images/ribbon_forkme.png">
            </a>
            <form action='http://www.cloudfoundry.com/search' class='search-docs-form' method='get' onsubmit='return submitQuery()'>
              <input autocomplete='off' class='search-docs-input' id='search-query' name='q' onfocus="this.placeholder = 'more:docs '" placeholder='' type='search-docs' value='more:docs '>
            </form>
            <br clear="left">
            
              <div class="breadcrumbs">
                <ul>
                  <li>
                    <a href="/">Home</a>
                  </li>
                  <li class=""><a href="/docs/running/">Running Cloud Foundry</a></li> <li class=""><a href="/docs/running/architecture/">Architecture</a></li> <li class="active"><span>Warden</span></li>
                </ul>
              </div>
              <br clear="left">

			

              <div class="quick-links"></div>

              <h1>Warden</h1>

            
            <p>Warden manages isolated, ephemeral, and resource controlled environments.</p>

<p>The primary goal of Warden is to provide a simple API for managing isolated environments. These isolated environments, or <em>containers</em>, can be limited in terms of CPU usage, memory usage, disk usage, and network access. As of writing, the only supported OS is Linux.</p>

<h2>Components</h2>

<p>This repository contains the following components:</p>

<ul>
<li><code>warden</code>: server</li>
<li><code>warden-protocol</code>: protocol definition, used by both the server and clients</li>
<li><code>warden-client</code>: client (Ruby)</li>
<li><code>em-warden-client</code>: client (Ruby&#39;s EventMachine)</li>
</ul>

<h2>Getting Started</h2>

<p>This short guide assumes Ruby 1.9 and Bundler are already available. Ensure that Ruby 1.9 has GNU readline library support through the package: &#39;libreadline-dev&#39; and zlib support through the &#39;zlib1g-dev&#39; package.</p>

<h4>Install the right kernel</h4>

<p>If you are running Ubuntu 10.04 (Lucid), make sure the backported Natty kernel is installed. After installing, reboot the system before continuing.</p>

<pre class="terminal">
$ sudo apt-get install -y linux-image-generic-lts-backport-natty
</pre>

<h4>Install dependencies</h4>

<pre class="terminal">
$ sudo apt-get install -y build-essential debootstrap
</pre>

<h4>Setup Warden</h4>

<p>Run the setup routine, which compiles the C code bundled with Warden and sets up the base file system for Linux containers.</p>

<pre class="terminal">
$ sudo bundle exec rake setup[config/linux.yml]
</pre>

<p><em>NOTE</em>: If <code>sudo</code> complains that <code>bundle</code> cannot be found, try <code>sudo env PATH=$PATH</code> to pass your current <code>PATH</code> to the <code>sudo</code> environment.</p>

<p>The setup routine sets up the file system for the containers at the directory path specified under the key <code>server -&gt; container_rootfs_path</code> in the config file <code>config/linux.yml</code>.</p>

<h4>Run Warden</h4>

<pre class="terminal">
$ sudo bundle exec rake warden:start[config/linux.yml]
</pre>

<h4>Interact with Warden</h4>

<pre class="terminal">
$ bundle exec bin/warden
</pre>

<h2>Implementation for Linux</h2>

<p>Isolation is achieved by namespacing kernel resources that would otherwise be shared. The intended level of isolation is set such that multiple containers present on the same host should not be aware of each others presence. This means that these containers are given (among others) their own Process ID (PID) namespace, network namespace, and mount namespace.</p>

<p>Resource control is done by using <a href="http://kernel.org/doc/Documentation/cgroups/cgroups.txt">Control Groups</a>. Every container is placed in its own control group, where it is configured to use an equal slice of CPU compared to other containers, and the maximum amount of memory it may use.</p>

<p>The following sections give a brief summary of the techniques used to implement the Linux backend for Warden. A more detailed description can be found in the <code>root/linux</code> directory of this repository.</p>

<h3>Networking</h3>

<p>Every container is assigned a network interface which is one side of a virtual ethernet pair created on the host. The other side of the virtual ethernet pair is only visible on the host (from the root namespace).  The pair is configured to use IPs in a small and static subnet. Traffic from and to the container can be forwarded using NAT. Additionally, all traffic can be filtered and shaped as needed, using readily available tools such as <code>iptables</code>.</p>

<h3>Filesystem</h3>

<p>Every container gets a private root filesystem. This filesystem is created by stacking a read-only filesytem and a read-write filesystem. This is implemented by using <code>aufs</code> on Ubuntu versions from 10.04 up to 11.10, and <code>overlayfs</code> on Ubuntu 12.04.</p>

<p>The read-only filesystem contains the minimal set of Ubuntu packages and Warden-specific modifications common to all containers. The read-write filesystem stores files overriding container-specific settings when necessary. Because all writes are applied to the read-write filesystem, containers can share the same read-only base filesystem.</p>

<p>The read-write filesystem is created by formatting a large sparse file. Because the size of this file is fixed, the filesystem that it contains cannot grow beyond this initial size.</p>

<h3>Difference with LXC</h3>

<p>The <em>Linux Containers</em> or <em>LXC</em> project has goals that are similar to those of Warden; isolation and resource control. They both use the same Linux kernel primitives to achieve their goals. In fact, early versions of Warden even <strong>used LXC</strong>.</p>

<p>The major difference between the two projects is that LXC is explicitly tied to Linux, where Warden backends can be implemented for any operating system that implements some way of isolating environments.  It is a daemon that manages containers and can be controlled via a simple API rather than a set of tools that are individually executed.</p>

<p>While the Linux backend for Warden was initially implemented with LXC, the current version no longer depends on it. During development, we found that running LXC out of the box is a very opaque and static process. There is little control over when different parts of the container start process are executed, and how they relate to each other.  Because Warden relies on a very small subset of the functionality that LXC offers, we decided to create a tool that only implements the functionality we need in under 1k LOC of C code. This tool executes preconfigured hooks at different stages of the container start process, such that required resources can be set up without worrying about concurrency issues. These hooks make the start process more transparent, allowing for easier debugging when parts of this process are not working as expected.</p>

<h2>Container Lifecycle</h2>

<p>The entire lifecyle of containers is managed by Warden. The API allows users to create, configure, use, and destroy containers. Additionally, it can automatically clean up unused containers when needed.  </p>

<h3>Create</h3>

<p>Every container is identified by its <em>handle</em>, which is returned by Warden upon creating it. It is a hexadecimal representation of the IP address that is allocated for the container. Regardless of whether the backend providing the container functionality supports networking or not, an IP address will be allocated by Warden to identify a container.</p>

<p>When a container was created and its handle was returned to the caller, it is immediately ready for use. All resources will be allocated, the necessary processes will be started and all firewalling tables will have been updated.</p>

<p>If Warden is configured to clean up containers after activity, it will use the number of connections that have referenced the container as a metric to determine inactivity. If the number of connections referencing the container drops to zero, the container will automatically be destroyed after a preconfigured interval. If in the mean time the container is referenced again, this timer is cancelled.</p>

<h3>Use</h3>

<p>The container can be used by running arbitrary scripts, copying files in and out, modifying firewall rules and modifying resource limits. A complete list of operations is discussed under &ldquo;Interface&rdquo;.  </p>

<h3>Destroy</h3>

<p>When a container is destroyed - either per user request, or automatically after being idle - Warden first kills all unprivileged processes running inside the container. These processes first receive a <code>TERM</code> signal followed by a <code>KILL</code> if they haven&#39;t exited after a couple of seconds. When these processes have terminated, the root of the container&#39;s process tree is sent a <code>KILL</code>. Once all resources the container used have been released, its files are removed and it is
considered destroyed.</p>

<h2>Networking</h2>

<h2>Interface</h2>

<p>Warden uses a line-based JSON protocol to communicate with its clients, and does so over a Unix socket which is located at <code>/tmp/warden.sock</code> by default. Every command invocation is formatted as a JSON array, where the first element is the command name and subsequent elements can be any JSON object. The commands it responds to are as follows:</p>

<h3><code>create [CONFIG]</code></h3>

<p>Creates a new container.</p>

<p>Returns the handle of the container which is used to identify it.</p>

<p>The optional <code>CONFIG</code> parameter is a hash that specifies configuration options used during container creation. The supported options are:</p>

<h4><code>bind_mounts</code></h4>

<p>If supplied, this specifies a set of paths to be bind mounted inside the container. The value must be an array. The elements in this array specify the bind mounts to execute, and are executed in order. Every element must be of the form:</p>
<pre class="highlight text">[
  # Path in the host filesystem
  &quot;/host/path&quot;,

  # Path in the container
  &quot;/path/in/container&quot;,

  # Optional hash with options. The `mode` key specifies whether the bind
  # mount should be remounted as `ro` (read-only) or `rw` (read-write).
  {
    &quot;mode&quot; =&gt; &quot;ro|rw&quot;
  }
]
</pre>
<h4><code>grace_time</code></h4>

<p>If specified, this setting overrides the default time of a container not being referenced by any client until it is destroyed. The value can either be the number of seconds as floating point number or integer, or the <code>null</code> value to completely disable the grace time.</p>

<h4><code>disk_size_mb</code></h4>

<p>If specified, this setting overrides the default size of the container&#39;s scratch filesystem. The value is expected to be an integer number.  </p>

<h3><code>spawn HANDLE SCRIPT [OPTS]</code></h3>

<p>Run the script <code>SCRIPT</code> in the container identified by <code>HANDLE</code>.</p>

<p>Returns a job identifier that can be used to reap its exit status at some point in the future. Also, the connection that issued the command may go away and reconnect later while still being able to reap the job.</p>

<p>The optional <code>OPTS</code> parameter is a hash that specifies options modifying the command being run. The supported options are:</p>

<h4><code>privileged</code></h4>

<p>If true, this specifies that the script should be run as root.</p>

<h3><code>link HANDLE JOB_ID</code></h3>

<p>Reap the script identified by <code>JOB_ID</code>, running in the container identified by <code>HANDLE</code>.</p>

<p>Returns a 3-element tuple containing the integer exit status, a string containing its <code>STDOUT</code> and a string containing its <code>STDERR</code>. These elements may be <code>null</code> when they cannot be determined (e.g. the script couldn&#39;t be executed, was killed, etc.).</p>

<h3><code>stream HANDLE JOB_ID</code></h3>

<p>Stream <code>STDOUT</code> and <code>STDERR</code> of scripts identified by <code>JOB_ID</code>, running in the container identified by <code>HANDLE</code>.</p>

<p>Returns a 2-element tuple containing the type of stream viz. <code>STDOUT</code> or <code>STDERR</code> as the first element, and a chunk of the stream as the second element. Returns an empty tuple when no more data is available in the stream.</p>

<h3><code>limit HANDLE (mem) [VALUE]</code></h3>

<p>Set or get resource limits for the container identified by <code>HANDLE</code>.</p>

<p>The following resources can be limited:</p>

<ul>
<li>The memory limit is specified in number of bytes. It is enforced using the control group associated with the container. When a container exceeds this limit, one or more of its processes will be killed by the kernel. Additionally, the Warden will be notified that an OOM happened and it subsequently tears down the container.</li>
</ul>

<h3><code>net HANDLE in</code></h3>

<p>Forward a port on the external interface of the host to the container identified by <code>HANDLE</code>.</p>

<p>Returns the port number that is mapped to the container. This port number is the same on the inside of the container.</p>

<h3><code>net HANDLE out ADDRESS[/MASK][:PORT]</code></h3>

<p>Allow traffic from the container identified by <code>HANDLE</code> to the network address specified by <code>ADDRESS</code>. Additionally, the address may be masked
to allow a network of addresses, and a port to only allow traffic to a specific port.</p>

<p>Returns <code>ok</code>.</p>

<h3><code>copy HANDLE in SRC_PATH DST_PATH</code></h3>

<p>Copy the contents at <code>SRC_PATH</code> on the host to <code>DST_PATH</code> in the container identified by <code>HANDLE</code>.</p>

<p>Returns <code>ok</code>.</p>

<p>File permissions and symbolic links will be preserved, while hardlinks will be materialized. If <code>SRC_PATH</code> contains a trailing <code>/</code> only the contents of the directory will be copied. Otherwise, the outermost directory, along with its contents, will be copied. The unprivileged user will be the owner of the files in the container.</p>

<h3><code>copy HANDLE out SRC_PATH DST_PATH [OWNER]</code></h3>

<p>Copy the contents at <code>SRC_PATH</code> in the container identified by <code>HANDLE</code> to <code>DST_PATH</code> on the host.</p>

<p>Returns <code>ok</code>.</p>

<p>Its semantics are identical to <code>copy HANDLE in</code> except in respect to file ownership. By default, the files on the host will be owned by root. If the <code>OWNER</code> argument is supplied (in the form of <code>USER:GROUP</code>), files on the host will be chowned to this user/group after the copy has completed.</p>

<h3><code>stop HANDLE</code></h3>

<p>Stop processes running inside the container identified by <code>HANDLE</code>.</p>

<p>Returns <code>ok</code>.</p>

<p>Because all processes are taken down, unfinished scripts will likely terminate without an exit status being available.</p>

<h3><code>destroy HANDLE</code></h3>

<p>Stop processes and destroy all resources associated with the container identified <code>HANDLE</code>.</p>

<p>Returns <code>ok</code>.</p>

<p>Because everything related to the container is destroyed, artifacts from running an earlier script should be copied out before calling <code>destroy</code>.</p>

<h2>Configuration</h2>

<p>Warden can be configured by passing a configuration file when it is started. An example configuration is located at <code>config/linux.yml</code> in the repository.</p>

<h2>System prerequisites</h2>

<p>Warden runs on Ubuntu 10.04 and higher.</p>

<p>A backported kernel needs to be installed on 10.04. This kernel is available as <code>linux-image-server-lts-backport-natty</code> (substitute <code>server</code> for <code>generic</code> if you are running Warden on a desktop variant of Ubuntu 10.04).</p>

<p>Other dependencies are:</p>

<ul>
<li>build-essential (for compiling Warden&#39;s C bits)</li>
<li>debootstrap (for bootstrapping the container&#39;s base filesystem)</li>
<li>quota (for managing file system quotas)</li>
</ul>

<p>Further bootstrapping of Warden can be done by running <code>rake setup</code>.</p>

<h2>Hacking</h2>

<p>The included tests create and destroy real containers, so require system prerequisites to be in place. They need to be run as root if the backend
to be tested requires it.</p>

<p>See <code>root/&lt;backend&gt;/README.md</code> for backend-specific information.</p>

          </div><!-- End of content_inner -->
        </div><!-- End of container-full -->
      </div><!-- End of content -->
    </div><!-- End of non_footer -->
    <div id='footer'>
      <div id='container-footer'>
        <div class='bg_social'>
          <ul class='social'>
            <li>
            <a href='http://twitter.com/cloudfoundry' target='_blank'>
            <img alt='Twitter' src='/images/twitter_large.png'>
            </a>
            </li>
            <li>
            <a href='https://plus.google.com/114245065906861739918/posts' target='_blank'>
            <img alt='Google+' src='/images/g+_large.png'>
            </a>
            </li>
            <li>
            <a href='http://facebook.com/cloudfoundry' target='_blank'>
            <img alt='Facebook' src='/images/facebook_large.png'>
            </a>
            </li>
            <li>
            <a href='http://youtube.com/cloudfoundry' target='_blank'>
            <img alt='Youtube' src='/images/youtube_large.png'>
            </a>
            </li>
          </ul>
        </div><!-- End of bg_social -->
        <ul class='links'>
                <li>
                    <a href='http://www.cloudfoundry.org/about.html'>About</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/blog.html'>Blog</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/about.html'>Partners</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/documentation.html'>Docs</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/faq.html'>FAQ</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/getinvolved.html'>Get Involved</a>
                </li>
        </ul>
        <div class='copyright'>
          <div class='hr-horizontal-dark'></div>
          <br>
          <p>
            &copy;
            <script>
              //<![CDATA[
                var d = new Date();
                document.write(d.getFullYear());
              //]]>
            </script>
            IBM
          </p>
        </div><!-- End of copyright -->
      </div><!-- End of container-footer -->
    </div><!-- End of footer -->
    <script type="text/javascript">
      (function() {
        var didInit = false;
        function initMunchkin() {
          if(didInit === false) {
            didInit = true;
            Munchkin.init('625-IUJ-009');
          }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function() {
          if (this.readyState == 'complete' || this.readyState == 'loaded') {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
      })();
    </script>
  </body>
</html>
