<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Deploying Community Services</title>

    <link href="/stylesheets/master.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/all.js" type="text/javascript"></script>
    <link href='/images/favicon.ico' rel='shortcut icon'>
    <script type="text/javascript">
      $(document).ready(function(){
        $('a#search').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 20px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2').css("padding","11px 10px 8px");
          $('#search-on').show();
          $('#search-off').hide();
        });
        $('.cancel-x').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 63px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2, #organization_bar .navbar .nav>li a#search').css("padding","16px 20px 15px");
          $('#organization_bar .navbar .nav>li a#getinvolved').css("padding","11px 92px 8px");
          $('#organization_bar .navbar .nav>li#docs-off .docs-list-list a').css("padding","0");
          $('#search-on').hide();
          $('#search-off').show();
        });f
        $(".togglebutton").click(function () {
        var divname= this.value;
          $("#"+divname).show("slow").siblings().hide("slow");
        });
      });
    </script>

    <!--[if lt IE 9]>
    <style>
        #content .container-full {background:  #ebf0fa;}
        .call-to-contribute-box, .column-left, .column-middle, .column-right {background:#e3e8f2}
        #footer {background:#000;}
    </style>
    <![endif]-->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-22181585-1']);
      _gaq.push(['_setDomainName', 'cloudfoundry.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body class="docs docs_running docs_running_deploying-cf docs_running_deploying-cf_adding-services">
    <img id="bg" src="/images/bg-plain-x.jpg">
    <div id='non_footer'>
      <div id='content'>
            <div class="text-center" style="background: url(/images/bg-crowd.png);background-position:center bottom;background-repeat:no-repeat">
                <img src="/images/logo_org.png">
            </div>
          <br></br>
        <div class='container-full'>
          <div id='organization_bar'>
            <div class='navbar'>
              <ul class='nav'>
                            <li id='icon-home-li'>
                                <a id='icon-home-link' href='/'>
                                    <img id='icon-home' src='http://blog.cloudfoundry.com/wp-content/static/cforg/img/icon-home.png'>
                                </a>
                            </li>
                            <li>
                                <a id='about' href='http://www.cloudfoundry.org/about.html'>About</a>
                            </li>
                            <li>
                                <a id='learn' href='http://www.cloudfoundry.org/learn.html'>Learn</a>
                            </li>
                            <li>
                                <a href='http://www.cloudfoundry.org/documentation.html'>Documentation</a>
                            </li>
                            <li>
                                <a id='get-involved' href='http://www.cloudfoundry.org/getinvolved.html'>Get Involved</a>
                            </li>

                <li id='docs-off'>
                    <!--
                  <a href='/' id='docs'>
                    <div id='icon-docs'></div>
                  </a>
                     -->
                  <div id='docs-list'>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/using/app-arch/'>Using Cloud Foundry</a>
                      <br>
                      <a href="/docs/using/app-arch/">Application Architecture Considerations</a>
                      <br>
                      <a href='/docs/using/deploying-apps/'>Deploying Apps</a>
                      <br>
                      <a href='/docs/using/managing-apps/'>Managing Apps</a>
                      <br>
                      <a href='/docs/using/services.html'>Using Services</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/using/">See all</a>
                    </div><!-- End of 1st column docs-list-list-->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/running/'>Running Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/architecture/'>Architecture</a>
                      <br>
                      <a href='/docs/running/bosh/'>BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf/'>Deploying with BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf-with-chef/'>Deploying with Chef</a>
                      <br>
                      <a href='/docs/running/micro_cloud_foundry/'>Micro Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/managing-cf/index.html'>Managing Cloud Foundry</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/running/">See all</a>
                    </div><!-- End of column 2 docs-list-list -->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/reference/'>Reference</a>
                      <br>
                      <a href='/docs/reference/cc-api.html'>Cloud Foundry REST API</a>
                      <br>
                      <a class="docs-list-th" href='/docs/dotcom/'>CloudFoundry.com</a>
                      <br>
                      <a href='/docs/dotcom/integration/'>Technical Integration</a>
                      <br>
                      <a class="docs-list-th" href='/docs/community/'>Community</a>
                    </div><!-- End of column 3 docs-list-list -->
                  </div><!-- End of docs-list -->
                </li>
                  <!--
                <li id='search-off'>
                  <a id='search'>
                    <div class='icon-search'></div>
                  </a>
                </li>
                <li id='search-on'>
                  <a id='search2'>
                    <form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
                      <input autocomplete='off' class='search-input' id='search-query' name='q' onfocus="this.placeholder = ''" placeholder='' type='search' value=''>
                    </form>
                    <div class="cancel-x"></div>
                  </a>
                </li>
                  -->
              </ul>
            </div><!-- End of navbar -->
          </div><!-- End of organization_bar -->
          <div class='content_inner'>
            <a class="forkme" href="http://github.com/cloudfoundry/cf-docs" target="_blank">
              <img alt="Fork me on GitHub" src="/images/ribbon_forkme.png">
            </a>
            <form action='http://www.cloudfoundry.com/search' class='search-docs-form' method='get' onsubmit='return submitQuery()'>
              <input autocomplete='off' class='search-docs-input' id='search-query' name='q' onfocus="this.placeholder = 'more:docs '" placeholder='' type='search-docs' value='more:docs '>
            </form>
            <br clear="left">
            
              <div class="breadcrumbs">
                <ul>
                  <li>
                    <a href="/">Home</a>
                  </li>
                  <li class=""><a href="/docs/running/">Running Cloud Foundry</a></li> <li class=""><a href="/docs/running/deploying-cf/">Deploying Cloud Foundry with BOSH</a></li> <li class="active"><span>Deploying Community Services</span></li>
                </ul>
              </div>
              <br clear="left">

			

              <div class="quick-links"></div>

              <h1>Deploying Community Services</h1>

            
            <p>Here&#39;s how we would add an example service (PostgreSQL) to your Cloud Foundry deployment. All users will be able to provision PostgreSQL databases and bind them to their applications (see <a href="/docs/using/services/">Using Services</a>).</p>

<p>The following services can be added to your Cloud Foundry by following the techniques on this page:</p>

<ul>
<li>elastic search</li>
<li>memcached</li>
<li>mongodb</li>
<li>postgresql</li>
<li>rabbitmq</li>
<li>redis</li>
<li>vlob</li>
</ul>

<h2>Status of document</h2>

<p>This page is written to support the <a href="https://github.com/cloudfoundry/cf-services-contrib-release">cf-services-contrib-release</a> project, for the <a href="https://github.com/cloudfoundry/cf-services-contrib-release/releases/tag/v1">v1 release</a>. Please consult the project for any newer versions that have not yet been documented here.</p>

<h2>Terminology</h2>

<p><strong>Note:</strong> One change in terminology has been made in Cloud Foundry v2. Service Gateways are now called Service Brokers, but unfortunately the term gateway still can be found in some source code and filenames. Wherever you see gateway in the context of Cloud Foundry Services, bear in mind that it&#39;s actually a broker. Apologies for the confusion, and thank you for your understanding during the transition.</p>

<ul>
<li>service gateway - advertises a catalog of services and plans to cloud controller, responsible for orphan management, and brokers user requests to provision, bind, unbind and un-provision service instances</li>
<li>service node - performs local instantiation, destruction and maintenance of service instances on a specific VM</li>
<li>service instance - a dedicated running server of a service, running inside a warden container; or a specific database of a shared running server (PostgreSQL)</li>
<li><a href="../../architecture/warden.html">warden</a> - Cloud Foundry&#39;s container technology</li>
<li>job - a server running within a bosh deployment</li>
<li>job template - the description of a single component - perhaps comprised of one or more running processes. For example, this could be a service gateway or service node. One or more job templates can be collocated in a single running job instance.</li>
</ul>

<h2>What will happen</h2>

<p>By the end of this page, you will have two additional VMs provisioned within your cloud.</p>

<p>They will be deployed within a dedicated bosh deployment (rather than add the configuration and VMs into your existing Cloud Foundry deployment).</p>

<p>The example below should work for either AWS EC2 or OpenStack (if you have image flavors <code>m1.small</code> and <code>m1.medium</code>) but modifications (networking) may be required for other Cloud Providers. You may need to adjust the resource pools in your deployment file to select available instance flavors/cloud properties.</p>

<p>One of the VMs will be running a shared PostgreSQL server that will be made available to the applications running on your Cloud Foundry. PostgreSQL databases can be allocated within this shared server (via <code>cf create-service</code>) and bound (via <code>cf bind-service</code>) to applications. This VM will also be running a Cloud Foundry component, the <code>postgresql_node_ng</code> job template (<a href="https://github.com/cloudfoundry/cf-release/tree/master/jobs/postgresql_node_ng">source</a>), this manages the PostgreSQL server on behalf of Cloud Foundry. It connects to the rest of Cloud Foundry via a <code>postgresql_gateway</code>.</p>

<p>The <code>postgresql_gateway</code> job (<a href="https://github.com/cloudfoundry/cf-release/tree/master/jobs/postgresql_gateway">source</a>) runs on the second VM being added. Each different type of service being included in a Cloud Foundry deployment needs a dedicated gateway process.</p>

<p>Each service node can support a single &ldquo;plan&rdquo;.</p>

<h2>Requirements</h2>

<p>The requirements are:</p>

<ul>
<li>the ability to provision two additional VMs, and one new persistent disk/volume</li>
<li>bosh running and configured for the target cloud account</li>
<li>base stemcell uploaded to bosh</li>
<li>bosh CLI installed</li>
<li>git installed</li>
</ul>

<h2>Upload final release of services</h2>

<pre class="terminal">
$ git clone https://github.com/cloudfoundry/cf-services-contrib-release.git
$ cd cf-services-contrib-release
$ bosh upload release releases/cf-services-contrib-1.yml
</pre>

<h2>Create a deployment file</h2>

<p>Download the <a href="https://raw.github.com/cloudfoundry/cf-services-contrib-release/master/examples/dns-postgresql.yml">example deployment file</a> for running a PostgreSQL service. For other services, see the example deployment file that <a href="https://raw.github.com/cloudfoundry/cf-services-contrib-release/master/examples/dns-all.yml">includes all services</a>.</p>

<p>In the following sections we will review the deployment file and make the following edits to your deployment file:</p>

<ul>
<li>set your bosh director&#39;s UUID</li>
<li>run the <code>postgresql_gateway_ng</code> job template in a dedicated <code>gateways</code> job instance</li>
<li>run the <code>postgresql_node_ng</code> job templates in one or more <code>postgresql_service_node</code> job instances (scale as necessary)</li>
<li>update the resource pool to match the required resources (for the gateway and service node jobs)</li>
<li>grant the service gateway access to your Cloud Controller &amp; UAA</li>
<li>describe the service plan that the service node will provide</li>
</ul>

<h3>Bosh director UUID</h3>

<p>To protect you from accidentally deploying the wrong deployment file to the wrong bosh, each deployment file includes a <code>director_uuid</code> field. That is, the deployment file is mapped to a specific bosh director.</p>

<p>To find your bosh UUID, run:</p>

<pre class="terminal">
$ bosh status
Director
  Name       firstbosh
  URL        https://1.2.3.4:25555
  Version    1.5.0.pre.877 (release:eee90e5e bosh:eee90e5e)
  User       admin
  UUID       2d19fdbc-7f1f-4a99-9c39-f024717b97e3
  CPI        openstack
  dns        enabled (domain_name: microbosh)
  compiled_package_cache disabled
  snapshots  disabled
</pre>

<p>The UUID is <code>2d19fdbc-7f1f-4a99-9c39-f024717b97e3</code> in the example above.</p>

<p>Now edit your deployment file to specify this UUID:</p>
<pre class="highlight text">director_uuid: 2d19fdbc-7f1f-4a99-9c39-f024717b97e3
</pre>
<h3>Target Cloud Foundry</h3>

<p>There are two locations in the deployment file where you need to change <code>mycloud.com</code> for your Cloud Foundry&#39;s root domain. Search and replace the following:</p>

<ul>
<li><code>api.mycloud.com</code></li>
<li><code>uaa.mycloud.com</code></li>
</ul>

<p>The service gateways announce themselves to the Cloud Controller via the first domain. It verifies that it has authorization to do so via the UAA, the second domain.</p>

<h3>Service Gateways</h3>

<p>Your PostgreSQL-only deployment file includes a job to run the gateway for PostgreSQL service.</p>

<p>Replace <code>mycloud.com</code> and <code>SERVICES_PASSWORD</code> with your base domain and your services user password (see below).</p>

<pre class="yaml">
jobs:
  - name: service_gateways
    release: cf-services-contrib
    template:
      - postgresql_gateway_ng
    instances: 1
    resource_pool: common
    networks:
      - name: default
        default: [dns, gateway]
    properties:
      uaa_client_id: "cf"
      uaa_endpoint: http://uaa.mycloud.com
      uaa_client_auth_credentials:
        username: services
        password: SERVICES_PASSWORD
</pre>

<p>The job-specific properties above are the UAA credentials to allow the gateway to authenticate with the UAA. No other job instance needs these credentials.</p>

<p>To find the <code>uaa_client_auth_credentials.password</code> value, look in your bosh deployment file for Cloud Foundry for a section that describes your <code>services</code> user:</p>

<pre class="yaml">
# from Cloud Foundry deployment file:
properties:
  ...
  uaa:
    ...
    scim:
      userids_enabled: true
      users:
      - admin|PASSWORD|scim.write,scim.read,openid,cloud_controller.admin,uaa.admin,password.write
      - services|SERVICES_PASSWORD|scim.write,scim.read,openid,cloud_controller.admin
</pre>

<p>In the <a href="https://raw.github.com/cloudfoundry/cf-services-contrib-release/master/examples/dns-all.yml">all services deployment file example</a> you can see how all the service gateways can be run on the same <code>gateways</code> job instance.</p>

<h3>PostgreSQL service node</h3>

<p>PostgreSQL itself - the actual database that provides PostgreSQL to applications - runs on a job instance running the <a href="https://github.com/cloudfoundry/cf-services-contrib-release/tree/master/jobs/postgresql_node_ng">postgresql<em>node</em>ng</a> job template. Your deployment file describes this with the <code>postgresql_service_node</code> reproduced below.</p>

<pre>
jobs:
- name: postgresql_service_node
  release: cf-services-contrib
  template: postgresql_node_ng
  instances: 1
  resource_pool: common
  networks:
    - name: default
      default: [dns, gateway]
  persistent_disk: 10000
  properties:
    postgresql_node:
      plan: default
</pre>

<p>There are two configurable aspects.</p>

<ul>
<li><code>persistent_disk</code> - instructs how big (Mb) a persistent disk should be assigned to each <code>postgresql_node</code> VM; this is shared amongst all PostgreSQL databases running on each VM</li>
<li><code>properties.postgresql_node.plan</code> - determines which of the service plans to support on this node</li>
</ul>

<p>In this tutorial we will configure one service plan (in the next section) called <code>default</code>. Therefore, we are specifying this <code>postgresql_node</code> service node to use that service plan.</p>

<p>Each service node can only support a single service plan.</p>

<p>The persistent disk size can be changed later - thanks to the power of bosh - and applied via <code>bosh deploy</code>.</p>

<h3>Configure a service plan</h3>

<p>Your deployment file contains a single service plan, called <code>default</code>.</p>

<pre>
# In your services deployment file:
properties:
  ...
  service_plans:
    postgresql:
      default:
        job_management:
          high_water: 1400
          low_water: 100
        configuration:
          lifecycle:
            enable: false

  postgresql_node:
    supported_versions: ["9.2"]
    default_version: "9.2"
    password: c1oudc0wc1oudc0w

  postgresql_gateway:
    cc_api_version: v2
    token: SOME_AUTH_TOKEN_STRING
    default_plan: default
    supported_versions: ["9.2"]
    version_aliases:
      current: "9.2"
</pre>

<p>NOTE: as of writing, the <code>high_water</code> &amp; <code>low_water</code> values are arbitrary and are not used by any services.</p>

<p>Support for backups will be documented in future, in this deployment file it is disabled.</p>

<p>If you want to allow your users to provision older versions of PostgreSQL, then you can extend the <code>supported_versions: [&quot;9.2&quot;]</code> arrays to include the other PostgreSQL versions to support.  Each version you specify will launch its own PostgreSQL &#39;postmaster&#39; to support those versions, all running on the same node.</p>

<h2>Deploy</h2>

<p>Your deployment file is now ready, your bosh has the <code>cf-services-contrib-release</code> description of all the services, gateways and nodes, and it also has a base stemcell used for each provisioned job instance. You can now deploy the services and they will add themselves into your Cloud Foundry deployment once they are running:</p>

<pre class="terminal">
$ bosh deployment path/to/deployment/file.yml
$ bosh deploy
</pre>

<h2>Authorize new service gateway</h2>

<p>Before you can use the services to provision/bind service instances via the <code>cf</code> CLI, you must authorize each service gateway with the Cloud Controller:</p>

<pre class="terminal">
$ cf create-service-auth-token
Label> postgresql

Token> SOME_AUTH_TOKEN_STRING
</pre>

<p>The &ldquo;Token&rdquo; value is from <code>postgresql_gateway.token</code> in the deployment file.</p>

<h2>Verify and provision</h2>

<pre class="terminal">
$ cf services --marketplace
Getting services... OK

service      version   provider   plans     description
postgresql   9.2       core       default   PostgreSQL database (vFabric)

$ cf create-service --version 9.2 --plan default --provider core --name test
</pre>

          </div><!-- End of content_inner -->
        </div><!-- End of container-full -->
      </div><!-- End of content -->
    </div><!-- End of non_footer -->
    <div id='footer'>
      <div id='container-footer'>
        <div class='bg_social'>
          <ul class='social'>
            <li>
            <a href='http://twitter.com/cloudfoundry' target='_blank'>
            <img alt='Twitter' src='/images/twitter_large.png'>
            </a>
            </li>
            <li>
            <a href='https://plus.google.com/114245065906861739918/posts' target='_blank'>
            <img alt='Google+' src='/images/g+_large.png'>
            </a>
            </li>
            <li>
            <a href='http://facebook.com/cloudfoundry' target='_blank'>
            <img alt='Facebook' src='/images/facebook_large.png'>
            </a>
            </li>
            <li>
            <a href='http://youtube.com/cloudfoundry' target='_blank'>
            <img alt='Youtube' src='/images/youtube_large.png'>
            </a>
            </li>
          </ul>
        </div><!-- End of bg_social -->
        <ul class='links'>
                <li>
                    <a href='http://www.cloudfoundry.org/about.html'>About</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/blog.html'>Blog</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/about.html'>Partners</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/documentation.html'>Docs</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/faq.html'>FAQ</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/getinvolved.html'>Get Involved</a>
                </li>
        </ul>
        <div class='copyright'>
          <div class='hr-horizontal-dark'></div>
          <br>
          <p>
            &copy;
            <script>
              //<![CDATA[
                var d = new Date();
                document.write(d.getFullYear());
              //]]>
            </script>
            IBM
          </p>
        </div><!-- End of copyright -->
      </div><!-- End of container-footer -->
    </div><!-- End of footer -->
    <script type="text/javascript">
      (function() {
        var didInit = false;
        function initMunchkin() {
          if(didInit === false) {
            didInit = true;
            Munchkin.init('625-IUJ-009');
          }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function() {
          if (this.readyState == 'complete' || this.readyState == 'loaded') {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
      })();
    </script>
  </body>
</html>
