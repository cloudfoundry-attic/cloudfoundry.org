<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Deploying Cloud Foundry on AWS</title>

    <link href="/stylesheets/master.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/all.js" type="text/javascript"></script>
    <link href='/images/favicon.ico' rel='shortcut icon'>
    <script type="text/javascript">
      $(document).ready(function(){
        $('a#search').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 20px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2').css("padding","11px 10px 8px");
          $('#search-on').show();
          $('#search-off').hide();
        });
        $('.cancel-x').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 63px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2, #organization_bar .navbar .nav>li a#search').css("padding","16px 20px 15px");
          $('#organization_bar .navbar .nav>li a#getinvolved').css("padding","11px 92px 8px");
          $('#organization_bar .navbar .nav>li#docs-off .docs-list-list a').css("padding","0");
          $('#search-on').hide();
          $('#search-off').show();
        });f
        $(".togglebutton").click(function () {
        var divname= this.value;
          $("#"+divname).show("slow").siblings().hide("slow");
        });
      });
    </script>

    <!--[if lt IE 9]>
    <style>
        #content .container-full {background:  #ebf0fa;}
        .call-to-contribute-box, .column-left, .column-middle, .column-right {background:#e3e8f2}
        #footer {background:#000;}
    </style>
    <![endif]-->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-22181585-1']);
      _gaq.push(['_setDomainName', 'cloudfoundry.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body class="docs docs_running docs_running_deploying-cf docs_running_deploying-cf_ec2 docs_running_deploying-cf_ec2_index">
    <img id="bg" src="/images/bg-plain-x.jpg">
    <div id='non_footer'>
      <div id='content'>
            <div class="text-center" style="background: url(/images/bg-crowd.png);background-position:center bottom;background-repeat:no-repeat">
                <img src="/images/logo_org.png">
            </div>
          <br></br>
        <div class='container-full'>
          <div id='organization_bar'>
            <div class='navbar'>
              <ul class='nav'>
                            <li id='icon-home-li'>
                                <a id='icon-home-link' href='/'>
                                    <img id='icon-home' src='http://blog.cloudfoundry.com/wp-content/static/cforg/img/icon-home.png'>
                                </a>
                            </li>
                            <li>
                                <a id='about' href='http://www.cloudfoundry.org/about.html'>About</a>
                            </li>
                            <li>
                                <a id='learn' href='http://www.cloudfoundry.org/learn.html'>Learn</a>
                            </li>
                            <li>
                                <a href='http://www.cloudfoundry.org/documentation.html'>Documentation</a>
                            </li>
                            <li>
                                <a id='get-involved' href='http://www.cloudfoundry.org/getinvolved.html'>Get Involved</a>
                            </li>

                <li id='docs-off'>
                    <!--
                  <a href='/' id='docs'>
                    <div id='icon-docs'></div>
                  </a>
                     -->
                  <div id='docs-list'>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/using/app-arch/'>Using Cloud Foundry</a>
                      <br>
                      <a href="/docs/using/app-arch/">Application Architecture Considerations</a>
                      <br>
                      <a href='/docs/using/deploying-apps/'>Deploying Apps</a>
                      <br>
                      <a href='/docs/using/managing-apps/'>Managing Apps</a>
                      <br>
                      <a href='/docs/using/services.html'>Using Services</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/using/">See all</a>
                    </div><!-- End of 1st column docs-list-list-->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/running/'>Running Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/architecture/'>Architecture</a>
                      <br>
                      <a href='/docs/running/bosh/'>BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf/'>Deploying with BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf-with-chef/'>Deploying with Chef</a>
                      <br>
                      <a href='/docs/running/micro_cloud_foundry/'>Micro Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/managing-cf/index.html'>Managing Cloud Foundry</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/running/">See all</a>
                    </div><!-- End of column 2 docs-list-list -->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/reference/'>Reference</a>
                      <br>
                      <a href='/docs/reference/cc-api.html'>Cloud Foundry REST API</a>
                      <br>
                      <a class="docs-list-th" href='/docs/dotcom/'>CloudFoundry.com</a>
                      <br>
                      <a href='/docs/dotcom/integration/'>Technical Integration</a>
                      <br>
                      <a class="docs-list-th" href='/docs/community/'>Community</a>
                    </div><!-- End of column 3 docs-list-list -->
                  </div><!-- End of docs-list -->
                </li>
                  <!--
                <li id='search-off'>
                  <a id='search'>
                    <div class='icon-search'></div>
                  </a>
                </li>
                <li id='search-on'>
                  <a id='search2'>
                    <form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
                      <input autocomplete='off' class='search-input' id='search-query' name='q' onfocus="this.placeholder = ''" placeholder='' type='search' value=''>
                    </form>
                    <div class="cancel-x"></div>
                  </a>
                </li>
                  -->
              </ul>
            </div><!-- End of navbar -->
          </div><!-- End of organization_bar -->
          <div class='content_inner'>
            <a class="forkme" href="http://github.com/cloudfoundry/cf-docs" target="_blank">
              <img alt="Fork me on GitHub" src="/images/ribbon_forkme.png">
            </a>
            <form action='http://www.cloudfoundry.com/search' class='search-docs-form' method='get' onsubmit='return submitQuery()'>
              <input autocomplete='off' class='search-docs-input' id='search-query' name='q' onfocus="this.placeholder = 'more:docs '" placeholder='' type='search-docs' value='more:docs '>
            </form>
            <br clear="left">
            
              <div class="breadcrumbs">
                <ul>
                  <li>
                    <a href="/">Home</a>
                  </li>
                  <li class=""><a href="/docs/running/">Running Cloud Foundry</a></li> <li class=""><a href="/docs/running/deploying-cf/">Deploying Cloud Foundry with BOSH</a></li> <li class="active"><span>Deploying Cloud Foundry on AWS</span></li>
                </ul>
              </div>
              <br clear="left">

			

              <div class="quick-links"><ul>
<li><a href="#domain-prep">Prepare a Domain</a></li>
<li><a href="#deployment-env-prep">Prepare the Deployment Environment</a></li>
<li><a href="#deploy-microbosh">Deploy Micro BOSH</a></li>
<li><a href="#deploy-cloudfoundry">Deploy Cloud Foundry</a></li>
<li><a href="#deploy-notes">BOSH Deployment Notes</a></li>
<li><a href="#destroy-environment">Destroying the AWS Environment</a></li>
</ul>
</div>

              <h1>Deploying Cloud Foundry on AWS</h1>

            
            <p><table style="width: 64%;"><tr><td>
  <strong>WARNING</strong>: The command <code>bosh aws destroy</code> destroys all S3 buckets, all instances, all everything in your AWS account. Do not use this command unless everything in your AWS account, including stuff that has nothing to do with Cloud Foundry, is expendable.
  </td></tr></table></p>

<p>Cloud Foundry tools simplify the process of deploying a Cloud Foundry instance to a variety of platforms, including Amazon Web Services. The following sections guide you through using BOSH and cf to deploy Cloud Foundry to Amazon Web Services.</p>

<h2><a id='domain-prep'></a> Prepare a Domain</h2>

<p>The first thing to do is to pick a DNS domain name for your Cloud Foundry instance. If you pick <em>cloud.mydomain.com</em>, your applications will be available as <em>app-name.cloud.mydomain.com</em>.</p>

<p>Create an AWS Route 53 Hosted Zone for your domain at the <a href="https://console.aws.amazon.com/route53">Route 53 control panel</a>. The control panel shows you a &ldquo;delegation set&rdquo; - a list of addresses to which you must delegate DNS authority for your domain. If your domain is <em>cloud.mydomain.com</em>, each address in the delegation set should become an NS record in the DNS server for <em>mydomain.com</em>.</p>

<p><img src="/images/bosh-aws/hostedzone.png" /></p>

<h2><a id='deployment-env-prep'></a> Prepare the Deployment Environment</h2>

<p>Ruby 1.9.3 and git (1.8 or later) are prerequisites for the following steps. After you install Ruby and git, install the <code>bundler</code> RubyGem:</p>

<pre class="terminal">
$ gem install bundler
</pre>

<p>Create a working directory from which to deploy the environment. For example, <code>$HOME/cf</code>. In that directory, create a file named <code>Gemfile</code> with the following contents:</p>
<pre class="highlight text">source &#39;https://rubygems.org&#39;

ruby &quot;1.9.3&quot;

gem &quot;bootstrap-cf-plugin&quot;, :git =&gt; &quot;git://github.com/cloudfoundry/bootstrap-cf-plugin&quot;
gem &quot;bosh&quot;
</pre>
<p>Install the latest release of the bootstrap plugin.</p>

<pre class="terminal">
$ cd $HOME/cf
~/cf$ bundle install
</pre>

<p>Next, set environment variables required for deploying to AWS. Create a file called <code>bosh_environment</code> and add the following, changing the value for each line to suit your configuration:</p>
<pre class="highlight text">export BOSH_VPC_DOMAIN=mydomain.com
export BOSH_VPC_SUBDOMAIN=cloud # Pick something more unique than &#39;cloud&#39; to work around a temporary shortcoming of the tool
export BOSH_AWS_ACCESS_KEY_ID=your_key_asdv34tdf
export BOSH_AWS_SECRET_ACCESS_KEY=your_secret_asdf34dfg
export BOSH_AWS_REGION=us-east-1
export BOSH_VPC_SECONDARY_AZ=us-east-1a # see note below
export BOSH_VPC_PRIMARY_AZ=us-east-1d   # see note below
</pre>
<p><em>Note:</em> <code>BOSH_VPC_DOMAIN</code> and <code>BOSH_VPC_SUBDOMAIN</code> must correspond to the DNS domain name you set up when configuring Route 53. The values shown above correspond to the earlier Route 53 example of <em>cloud.mydomain.com</em>.</p>

<p><em>Note:</em> Now only deployment to <code>us-east-1</code> region is supported by next
steps. For MicroBOSH deploy please review <a href="https://gist.github.com/danhigham/5804252">following guide</a>.</p>

<p><em>Note:</em> Pull request in review process to add support for other AWS regions (<a href="https://github.com/cloudfoundry/bosh/pull/323">https://github.com/cloudfoundry/bosh/pull/323</a>)</p>

<p>Choose availability zones that are listed as &ldquo;operating normally&rdquo; on
the <a href="https://console.aws.amazon.com/ec2/v2/home?region=us-east-1">AWS Console Status Health Section</a>
for your region.</p>

<p>Use <code>source</code> to set them for the current shell:</p>

<pre class="terminal">
~/cf$ source bosh_environment
</pre>

<p>Run <code>bosh aws create</code> to create a VPC Internet Gateway, VPC subnets, 3 RDS databases, and a NAT VM for Cloud Foundry subnet routing. The command does not require user input, so start it and grab a coffee at the trendiest place across town!</p>

<pre class="terminal">
~/cf$ bosh aws create
Executing migration CreateKeyPairs
allocating 1 KeyPair(s)
Executing migration CreateVpc
. . .
details in S3 receipt: aws_rds_receipt and file: aws_rds_receipt.yml
Executing migration CreateS3
creating bucket xxxx-bosh-blobstore
creating bucket xxxx-bosh-artifacts
</pre>

<p><strong>Note:</strong> RDS database creation may take 20+ minutes to finish.</p>

<h2><a id='deploy-microbosh'></a> Deploy Micro BOSH</h2>

<p>Deploy Micro BOSH from the workspace directory, using the <code>bosh aws bootstrap micro</code> command:</p>

<pre class="terminal">
~/cf$ bosh aws bootstrap micro

WARNING! Your target has been changed to `https://10.10.0.6:25555'!
Deployment set to '/Users/pivotal/cf/deployments/micro/micro_bosh.yml'
Deploying new micro BOSH instance `micro/micro_bosh.yml' to `https://10.10.0.6:25555' (type 'yes' to continue): yes

Deploy Micro BOSH
  using existing stemcell (00:00:00)
. . .
Deployed `micro/micro_bosh.yml' to `https://10.10.0.6:25555', took 00:04:57 to complete
Logged in as `admin'
Enter username: foo
Enter password: ***
User `foo' has been created
Logged in as `foo'
User `hm' has been created
Logged in as `hm'
</pre>

<p>After Micro BOSH has been deployed succesfully, you can check its status:</p>

<pre class="terminal">
~/cf$ bosh status

Updating director data... done

Config
             ~/.bosh_config

Director
  Name       micro-xxxx
  URL        https://x.x.x.x:25555
  Version    1.5.0.pre.xxx (release:xxxxx bosh:xxxxx)
  User       hm
  UUID       xxxxxx-xxxx-xxxx-xxxx-xxxxxxxx
  CPI        aws
  dns        enabled (domain_name: microbosh)
  compiled_package_cache disabled

Deployment
  Manifest   ~/cf/deployments/micro/micro_bosh.yml
</pre>

<h2><a id='deploy-cloudfoundry'></a>Deploy Cloud Foundry</h2>

<p>Cloud Foundry can now be deployed using the <code>bundle exec cf bootstrap aws</code> command from the bootstrap-cf-plugin gem.</p>

<pre class="terminal">
~/cf$ bundle exec cf bootstrap aws
</pre>

<p>This process can take some time (2-3 hours), especially during its first run when all the jobs are compiled for the first time. When the bootstrap has finished installing Cloud Foundry, it should be possible to target the install with cf and login as an administrator with the user name <code>admin</code> and the password <code>the_admin_pw</code>.</p>

<p>If this command fails, it&#39;s <em>usually possible to rerun it again</em>.  You can also rerun it to deploy the latest version of CF, unless there are changes to the resources created in the &ldquo;bosh aws create&rdquo; step above (in which case it should fail).</p>

<p>If this command fails with the following error -  <strong>Error 400007: service_gateways/0&#39; is not running after update</strong> - your networking is probably not set up correctly. You can check that with the following command (substituting your own subdomain and domain):</p>

<pre class="terminal">
~/cf$ curl api.subdomain.domain/info
</pre>

<p>If that is successful it should return the information as json. Otherwise, check your networking. <em>Tip</em> - make sure your domain has an NS record for your subdomain.</p>

<p>This bootstrap command runs two phases: first, several BOSH commands are executed and then several CF commands are executed. At the end of the process, you have the following primitives:</p>

<ul>
<li>2 BOSH releases: cf-release and cf-services-release, each pulled from the latest &ldquo;green&rdquo; release-candidate branch in github.</li>
<li>The latest &ldquo;green&rdquo; BOSH stemcell, downloaded from our CI server.</li>
<li>2 already-deployed BOSH deployments: CF core and CF services, backed by generated manifest files described below.</li>
<li>2 CF admin user accounts with randomly-generated passwords (find in cf-shared-secrets.yml).</li>
<li>A default CF organization called &ldquo;bootstrap-org&rdquo;.</li>
<li>A default CF space called &ldquo;bootstrap-space&rdquo;.</li>
<li>CF service-auth-tokens allowing CF core to authenticate to CF services.</li>
</ul>

<p>At this point your &ldquo;cf&rdquo; command-line tool is targeted to your CF deployment and you are authenticated as the admin user, meaning <em>you&#39;re ready to push an app</em>!</p>

<h2><a id='deploy-notes'></a> BOSH Deployment Notes</h2>

<p>Once Cloud Foundry has been deployed using the bootstrap cf plugin, there will be several files left in the <code>$HOME/cf</code> folder:</p>

<table>
  <tr><th>File</th><th>Purpose</th></tr>
  <tr>
    <td>cf-aws.yml</td>
    <td>BOSH manifest file for Cloud Foundry that was used to deploy to AWS. You can use this file to redeploy the Cloud Foundry instance again. For more information, see <a href="">managing BOSH deployments</a>.</td>
  </tr>
  <tr>
    <td>cf-services-aws.yml</td>
    <td>BOSH manifest file for Cloud Foundry services.
  </tr>
  <tr>
    <td>cf-shared-secrets.yml</td>
    <td>Shared secrets file for usernames and passwords used in various Cloud Foundry components.</td>
  </tr>
  <tr>
    <td>director.key and director.pem</td>
    <td>Self-signed SSL certificate used to encrypt the connection between BOSH CLI and Micro BOSH.</td>
  </tr>
  <tr>
    <td>elb-cfrouter.key and elb-cfrouter.pem</td>
    <td>Self-signed SSL certificate installed on the AWS ELB that fronts the Cloud Foundry routing layer.</td>
  </tr>
  <tr>
    <td>aws_rds_receipt.yml, aws_route53_receipt.yml, aws_vpc_receipt.yml</td>
    <td>At the end of the MicroBOSH bootstrapping procedure, these &lsquo;receipt&rsquo; files are written to provide data used to template the manifest file used for deploying Cloud Foundry.</td>
  </tr>
</table>

<p>For more information about managing organizations, spaces, and users, go to the <a href="/docs/using/managing-apps/cf/">cf</a> page.</p>

<h2><a id='destroy-environment'></a>Destroying the AWS Environment</h2>

<p><table style="width: 70%;"><tr><td>
    <strong>WARNING</strong>: The command <code>bosh aws destroy</code> destroys all S3 buckets, all instances, <strong>all everything</strong> in your AWS account. Do not use this command unless everything in your AWS account, including stuff that has nothing to do with Cloud Foundry, is expendable.
  </td></tr></table></p>

<p>You also want to cleanup any YAML artifacts that are no longer valid:</p>

<pre class="terminal">
~/cf$ bosh aws destroy
~/cf$ rm -f *.yml
</pre>

<p><img id="nuclear" src='/images/nuclear2.jpg'>
<br clear="left">Photo: Creative Commons / CTBTO Photostream at <a href="http://www.flickr.com/photos/ctbto/6476282811/">http://www.flickr.com/photos/ctbto/6476282811/</a></p>

          </div><!-- End of content_inner -->
        </div><!-- End of container-full -->
      </div><!-- End of content -->
    </div><!-- End of non_footer -->
    <div id='footer'>
      <div id='container-footer'>
        <div class='bg_social'>
          <ul class='social'>
            <li>
            <a href='http://twitter.com/cloudfoundry' target='_blank'>
            <img alt='Twitter' src='/images/twitter_large.png'>
            </a>
            </li>
            <li>
            <a href='https://plus.google.com/114245065906861739918/posts' target='_blank'>
            <img alt='Google+' src='/images/g+_large.png'>
            </a>
            </li>
            <li>
            <a href='http://facebook.com/cloudfoundry' target='_blank'>
            <img alt='Facebook' src='/images/facebook_large.png'>
            </a>
            </li>
            <li>
            <a href='http://youtube.com/cloudfoundry' target='_blank'>
            <img alt='Youtube' src='/images/youtube_large.png'>
            </a>
            </li>
          </ul>
        </div><!-- End of bg_social -->
        <ul class='links'>
                <li>
                    <a href='http://www.cloudfoundry.org/about.html'>About</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/blog.html'>Blog</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/about.html'>Partners</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/documentation.html'>Docs</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/faq.html'>FAQ</a>
                </li>
                <li class='disc'>•</li>
                <li>
                    <a href='http://www.cloudfoundry.org/getinvolved.html'>Get Involved</a>
                </li>
        </ul>
        <div class='copyright'>
          <div class='hr-horizontal-dark'></div>
          <br>
          <p>
            &copy;
            <script>
              //<![CDATA[
                var d = new Date();
                document.write(d.getFullYear());
              //]]>
            </script>
            IBM
          </p>
        </div><!-- End of copyright -->
      </div><!-- End of container-footer -->
    </div><!-- End of footer -->
    <script type="text/javascript">
      (function() {
        var didInit = false;
        function initMunchkin() {
          if(didInit === false) {
            didInit = true;
            Munchkin.init('625-IUJ-009');
          }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function() {
          if (this.readyState == 'complete' || this.readyState == 'loaded') {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
      })();
    </script>
  </body>
</html>
