<!doctype html>
<html>
  <head>
    <meta charset="utf-8">

    <!-- Always force latest IE rendering engine or request Chrome Frame -->
    <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

    <!-- Use title if it's in the page YAML frontmatter -->
    <title>Troubleshooting Wardenized Services</title>

    <link href="/stylesheets/master.css" media="screen" rel="stylesheet" type="text/css" />
    <link href="/stylesheets/style.css" media="screen" rel="stylesheet" type="text/css" />
    <script src="/javascripts/all.js" type="text/javascript"></script>
    <link href='/images/favicon.ico' rel='shortcut icon'>
    <script type="text/javascript">
      $(document).ready(function(){
        $('a#search').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 20px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2').css("padding","11px 10px 8px");
          $('#search-on').show();
          $('#search-off').hide();
        });
        $('.cancel-x').click(function () {
          $('#organization_bar .navbar .nav>li a').css("padding","11px 63px 8px");
          $('#organization_bar .navbar .nav>li a#docs').css("padding","14px 20px");
          $('#organization_bar .navbar .nav>li a#search2, #organization_bar .navbar .nav>li a#search').css("padding","16px 20px 15px");
          $('#organization_bar .navbar .nav>li a#getinvolved').css("padding","11px 92px 8px");
          $('#organization_bar .navbar .nav>li#docs-off .docs-list-list a').css("padding","0");
          $('#search-on').hide();
          $('#search-off').show();
        });f
        $(".togglebutton").click(function () {
        var divname= this.value;
          $("#"+divname).show("slow").siblings().hide("slow");
        });
      });
    </script>

    <!--[if lt IE 9]>
    <style>
        #content .container-full {background:  #ebf0fa;}
        .call-to-contribute-box, .column-left, .column-middle, .column-right {background:#e3e8f2}
        #footer {background:#000;}
    </style>
    <![endif]-->
    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-22181585-1']);
      _gaq.push(['_setDomainName', 'cloudfoundry.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>
  </head>

  <body class="docs docs_running docs_running_troubleshooting docs_running_troubleshooting_troubleshooting-warden-services">
    <img id="bg" src="/images/bg-plain-x.jpg">
    <div id='non_footer'>
      <div id='header'>
        <div class='container_wide'>
          <ul class='actions'>
            <li class='last'>
              <a href="http://www.cloudfoundry.com/contact">Contact Us</a>
            </li>
            <li>
              <a class='register_link' href='http://login.run.pivotal.io/login'>My Account</a>            
            </li>
          </ul>
        </div>
      </div>
      <div id='content'>
        <div class='logo-main'>
          <div class='logo'>
            <a href='http://www.cloudfoundry.com'>
            <img src='/images/logo-cloudfoundry.png'>
            </a>
            <a href='http://www.gopivotal.com' target="_blank">
            <img id="pivotal-logo" src='/images/logo-pivotal.png'>
            </a>
          </div>
          <div class='cta'>
            <a href='https://console.run.pivotal.io'>
            <img src='/images/signup_freetrial.png'>
            </a>
          </div>
        </div><!-- End of logo-main-->
        <div class='container-full'>
          <div id='organization_bar'>
            <div class='navbar'>
              <ul class='nav'>
                <li>
                <a href='http://www.cloudfoundry.com/use' id='use'>Using Cloud Foundry</a>
                </li>
                <li>
                <a href='http://www.cloudfoundry.com/run' id='run'>Running Cloud Foundry</a>
                </li>
                <li>
                <a href='http://www.cloudfoundry.com/getinvolved' id='getinvolved'>Get Involved</a>
                </li>
                <li id='docs-off'>
                  <a href='/' id='docs'>
                    <div id='icon-docs'></div>
                  </a>
                  <div id='docs-list'>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/using/app-arch/'>Using Cloud Foundry</a>
                      <br>
                      <a href="/docs/using/app-arch/">Application Architecture Considerations</a>
                      <br>
                      <a href='/docs/using/deploying-apps/'>Deploying Apps</a>
                      <br>
                      <a href='/docs/using/managing-apps/'>Managing Apps</a>
                      <br>
                      <a href='/docs/using/services.html'>Using Services</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/using/">See all</a>
                    </div><!-- End of 1st column docs-list-list-->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/running/'>Running Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/architecture/'>Architecture</a>
                      <br>
                      <a href='/docs/running/bosh/'>BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf/'>Deploying with BOSH</a>
                      <br>
                      <a href='/docs/running/deploying-cf-with-chef/'>Deploying with Chef</a>
                      <br>
                      <a href='/docs/running/micro_cloud_foundry/'>Micro Cloud Foundry</a>
                      <br>
                      <a href='/docs/running/managing-cf/index.html'>Managing Cloud Foundry</a>
                      <br>
                      <a class="docs-list-see-all" href="/docs/running/">See all</a>
                    </div><!-- End of column 2 docs-list-list -->
                    <div class="hr-vertical"></div>
                    <div class="docs-list-list">
                      <a class="docs-list-th" href='/docs/reference/'>Reference</a>
                      <br>
                      <a href='/docs/reference/cc-api.html'>Cloud Foundry REST API</a>
                      <br>
                      <a class="docs-list-th" href='/docs/dotcom/'>CloudFoundry.com</a>
                      <br>
                      <a href='/docs/dotcom/integration/'>Technical Integration</a>
                      <br>
                      <a class="docs-list-th" href='/docs/community/'>Community</a>
                    </div><!-- End of column 3 docs-list-list -->
                  </div><!-- End of docs-list -->
                </li>
                <li id='search-off'>
                  <a id='search'>
                    <div class='icon-search'></div>
                  </a>
                </li>
                <li id='search-on'>
                  <a id='search2'>
                    <form action='http://www.cloudfoundry.com/search' class='search-form' method='get' onsubmit='return submitQuery()'>
                      <input autocomplete='off' class='search-input' id='search-query' name='q' onfocus="this.placeholder = ''" placeholder='' type='search' value=''>
                    </form>
                    <div class="cancel-x"></div>
                  </a>
                </li>
              </ul>
            </div><!-- End of navbar -->
          </div><!-- End of organization_bar -->
          <div class='content_inner'>
            <a class="forkme" href="http://github.com/cloudfoundry/cf-docs" target="_blank">
              <img alt="Fork me on GitHub" src="/images/ribbon_forkme.png">
            </a>
            <form action='http://www.cloudfoundry.com/search' class='search-docs-form' method='get' onsubmit='return submitQuery()'>
              <input autocomplete='off' class='search-docs-input' id='search-query' name='q' onfocus="this.placeholder = 'more:docs '" placeholder='' type='search-docs' value='more:docs '>
            </form>
            <br clear="left">
            
              <div class="breadcrumbs">
                <ul>
                  <li>
                    <a href="/">Home</a>
                  </li>
                  <li class=""><a href="/docs/running/">Running Cloud Foundry</a></li> <li class=""><a href="/docs/running/troubleshooting/">Troubleshooting</a></li> <li class="active"><span>Troubleshooting Wardenized Services</span></li>
                </ul>
              </div>
              <br clear="left">

			

              <div class="quick-links"></div>

              <h1>Troubleshooting Wardenized Services</h1>

            
            <h2><a id="intro"></a>Introduction</h2>

<p>This document shows how to debug a Wardenized service in a development or production environment.</p>

<h2><a id=""></a>Debugging</h2>

<p>This section includes the following topics, with corresponding examples:</p>

<ul>
<li>Checking the status of Warden server</li>
<li>Checking the log and config of Warden</li>
<li>Looking into a Warden container</li>
<li>Service instance logs, data and localdb</li>
</ul>

<h3><a id="check-status"></a>Checking Status of Warden Server</h3>

<p>The status of a Warden server is monitored by monit. You can see the Warden server status by using the <code>monit status</code> command:</p>

<pre class="terminal">
$ monit status
The Monit daemon 5.2.4 uptime: 1d 1h 8m

Process 'warden'
status                            running
monitoring status                 monitored
pid                               4621
parent pid                        1
uptime                            1d 1h 7m
children                          8
memory kilobytes                  37112
memory kilobytes total            41708
memory percent                    0.2%
memory percent total              0.2%
cpu percent                       0.1%
cpu percent total                 0.1%
unix socket response time         0.000s to /tmp/warden.sock [DEFAULT]
data collected                    Tue Jan  8 07:11:52 2013
...
</pre>

<p>If the Warden server is running normally, you can see the server status using <code>ps</code> and <code>grep</code>:</p>

<pre class="terminal">
$ ps aux | grep warden
root      4621  0.1  0.2 125448 36644 ?        Sl   Jan07   2:37 ruby /var/vcap/data/packages/redis_node_ng/12.2-dev.1/warden/vendor/bundle/ruby/1.9.1/bin/rake warden:start[/var/vcap/jobs/redis_node_ng/config/warden.yml]
root      5342  0.0  0.0   5984   316 ?        S    06:43   0:00 /var/vcap/data/packages/redis_node_ng/12.2-dev.1/warden/src/oom/oom /sys/fs/cgroup/memory/instance-16io51f6jri
root      5592  0.0  0.0   5984   316 ?        S    06:43   0:00 /var/vcap/data/packages/redis_node_ng/12.2-dev.1/warden/src/oom/oom /sys/fs/cgroup/memory/instance-16io51f6jrj
root     15849  0.0  0.0   7688   844 pts/1    S+   07:10   0:00 grep --color=auto warden
</pre>

<h3><a id="check-log"></a>Checking the log and config of Warden</h3>

<p>The config file of Warden is normally found at <code>/var/vcap/jobs/foo_node_ng/config/warden.yml</code>:</p>

<pre class="terminal">
$ cat /var/vcap/jobs/redis_node_ng/config/warden.yml
---
server:
container_klass: Warden::Container::Linux
container_grace_time: ~
container_rootfs_path: /var/vcap/data/warden/rootfs
container_depot_path: /var/vcap/store/containers
unix_domain_permissions: 0777
container_rlimits:
  nofile: 2000
  # Redis-server forks a process to do dump,
  # so also increase the maximum number of processes,
  # the default limitation is 1024
  nproc: 2000
quota:
  disk_quota_enabled: false
logging:
file: /var/vcap/sys/log/warden/warden.log  
syslog: vcap.services.redis.warden
level: debug
network:
pool_start_address: 10.254.0.0
pool_size: 4096
user:
pool_start_uid: 10000
pool_size: 4096
</pre>

<p>The rootfs and container depot position is labelled in yellow and they could offer some information on debugging. The Warden log is labelled in green and it records whether the Warden server started correctly and how it handled incoming requests. The socket that the Warden server listens on is found at <code>/tmp/warden.sock</code>.</p>

<p>Warden uses <a href="https://github.com/cloudfoundry/steno">Steno</a> for logging. You can use <code>steno-prettify</code> to make it more human readable. <code>steno-prettify</code> is a gem that is installed with Warden so you can use it without additional installation after going into the <code>warden</code> directory:</p>

<pre class="terminal">
$ bundle exec steno-prettify /var/vcap/sys/log/warden/warden.log
2013-01-07 06:04:04.743379 Warden::Server pid=4621  tid=5798 fid=ee62 warden/server.rb/run!:240    DEBUG -- rlimit_nofile: 1024 => 32768
2013-01-07 06:04:05.372339 Warden::Container::Linux pid=4621  tid=5798 fid=ee62 container/spawn.rb/set_deferred_success:131    DEBUG -- Exited with status 0 (0.626s): [["/var/vcap/data/packages/redis_node_ng/12.2-dev.1/warden/src/closefds/closefds", "/var/vcap/data/packages/redis_node_ng/12.2-dev.1/warden/src/closefds/closefds"], "/var/vcap/data/packages/redis_node_ng/12.2-dev.1/warden/root/linux/setup.sh"]
2013-01-07 06:04:05.373243 Warden::Server pid=4621  tid=5798 fid=2add warden/server.rb/block (2 levels) in run!:282     INFO -- Listening on /tmp/warden.sock, and ready for action.
2013-01-07 06:04:21.776618 Warden::Server::Drainer pid=4621  tid=5798 fid=ee62 warden/server.rb/register_connection:53    DEBUG -- Connection registered: #<Warden::Server::ClientConnection:0x000000028fd7c8>
2013-01-07 06:04:21.777053 Warden::Server::Drainer pid=4621  tid=5798 fid=ee62 warden/server.rb/unregister_connection:60    DEBUG -- Connection unregistered: #<Warden::Server::ClientConnection:0x000000028fd7c8>
2013-01-07 06:04:31.784353 Warden::Server::Drainer pid=4621  tid=5798 fid=ee62 warden/server.rb/register_connection:53    DEBUG -- Connection registered: #<Warden::Server::ClientConnection:0x000000028e8df0>
2013-01-07 06:04:31.950572 Warden::Server::Drainer pid=4621  tid=5798 fid=ee62 warden/server.rb/unregister_connection:60    DEBUG -- Connection unregistered: #<Warden::Server::ClientConnection:0x000000028e8df0>
...
</pre>

<p>You can also redirect the prettified log to a file to make it easier for navigation.</p>

<h3><a id="looking"></a>Looking into a Warden container</h3>

<p>You can use the Warden client to talk to existing Warden containers and perform operations. The Warden client normally sits in <code>/path_to_warden_packages/bin/warden</code>:</p>

<pre class="terminal">
$ ./bin/warden
warden> list
handles[0] : 16io51f6jri
handles[1] : 16io51f6jrj
</pre>

<p>The Warden container is identified by its handle on a single node. You can run a script to get information in a Warden container:</p>

<pre class="terminal">
$ ./bin/warden
warden> run --handle 16io51f6jri --script "echo hello world"
hello world
...
</pre>

<p>In order to run operations with root privileges, you can use the <code>--privileged</code> option:</p>

<pre class="terminal">
$ ./bin/warden
warden> run --handle 16io51f6jri --script "sudo echo hello world" --privileged
hello world
...
</pre>

<p>The <code>help</code> option will give you more information on how to run a command or script within a Warden container.</p>

<p>There are other ways to check whether the process is running. For example, given that you have a container with handle <code>16io51f6jri</code> running <code>redis-server</code>, you can find the corresponding process tree:</p>

<pre class="terminal">
$ ps auxf
...
root      5291  0.0  0.0  14564   496 ?        S    06:43   0:00 wshd: 16io51f6jri                                                        
10000     5351  0.0  0.0  17708  1220 ?        Ss   06:43   0:00  \_ /bin/bash
10000     5353  0.1  0.0  36220  1772 ?        Sl   06:43   0:12      \_ /var/vcap/packages/redis26/bin/redis-server /var/vcap/store/redis/instances/9407af2c-0628-484b-a5f8-5c8634421a35/redis.conf
...
</pre>

<p>and</p>

<pre class="terminal">
$ pstree -p 5291
wshd(5291)───bash(5351)───redis-server(5353)─┬─{redis-server}(5362)
                                             └─{redis-server}(5363)
</pre>

<p>Its corresponding PID of <code>wshd</code> will be put into the corresponding Warden depot directory:</p>

<pre class="terminal">
$ cat /var/vcap/store/containers/16io51f6jri/run/wshd.pid
5291
</pre>

<h3><a id="service-data"></a>Service instance logs, data and localdb</h3>

<p>The data of the service sits in <code>/var/vcap/store/#{service_name}/instances/#{uuid}</code>:</p>

<pre class="terminal">
$ ls /var/vcap/store/redis/instances/
2b4e0275-7da1-4da7-88c1-7c907b6b1b8c  5e8bbae6-2c3d-429e-bec7-a5b695d2c4f4
</pre>

<p>The instance data directory normally contains the service PID, data directory and the instance specific config file. The log file of the instance sits in <code>/var/vcap/sys/service-log/#{service_name}/#{uuid}</code>:</p>

<pre class="terminal">
$ ls /var/vcap/sys/service-log/redis/
2b4e0275-7da1-4da7-88c1-7c907b6b1b8c  5e8bbae6-2c3d-429e-bec7-a5b695d2c4f4
</pre>

<p>Besides the service log, this directory also contains the <code>warden_service_ctl.log</code> and <code>warden_service_ctl.err.log</code>. <code>warden_service_ctl</code> is a script that controls the start, stop and status of the service instance.</p>

<p>The local sqlite database also includes valuable information for debugging issues with a service instance. The local sqlite database sits in <code>/var/vcap/store/#{service_name}/#{service_node.db}</code>. You can use the pre-installed <code>sqlite3</code> binary to look into the sqlite database:</p>

<pre class="terminal">
$ /var/vcap/packages/sqlite/bin/sqlite3 /var/vcap/store/redis/redis_node.db
SQLite version 3.7.5
Enter ".help" for instructions
Enter SQL statements terminated with a ";"

sqlite> .table
vcap_services_redis_node_provisioned_services

sqlite> PRAGMA table_info(vcap_services_redis_node_provisioned_services);
0|name|VARCHAR(50)|1||1
1|port|INTEGER|0||0
2|password|VARCHAR(50)|1||0
3|plan|INTEGER|1||0
4|pid|INTEGER|0||0
5|memory|INTEGER|0||0
6|container|VARCHAR(50)|0||0
7|ip|VARCHAR(50)|0||0
8|version|VARCHAR(50)|0||0

sqlite> select * from vcap_services_redis_node_provisioned_services;
5e8bbae6-2c3d-429e-bec7-a5b695d2c4f4|5000|0508e659-c6d0-4d6f-b64f-4ab1049984c7|1|0|20|16j9dohgvks|10.254.0.2|2.6
2b4e0275-7da1-4da7-88c1-7c907b6b1b8c|5001|cd189a0e-144c-44fa-8e36-281c38e52e5c|1|0|20|16j9dohgvkt|10.254.0.6|2.6
</pre>

<p>Some useful operations are listed above to show the table name, schema and values with the table that is used by the service node. The start, stop, and check_status operations on the instance are all done by the <code>warden_service_ctl</code> script. On the node, it sits in <code>/var/vcap/store/#{service_name}_common/bin</code>:</p>

<pre class="terminal">
$ ls /var/vcap/store/redis_common/bin/
utils.sh  warden_service_ctl
</pre>

<p>Service node code will use the <code>warden_service_ctl</code> script to start, stop, and ping the status of the service instance. You can also use the script manually with Warden client to start and stop the instance but it is dangerous to do that manually.</p>

<h2><a id="services"></a>Service specific issue</h2>

<h3><a id="services-mongo"></a>MongoDB proxy</h3>

<p>MongoDB has a corresponding proxy and they won’t be able to work without it. Mongodb will have their proxy running within Warden:</p>

<pre class="terminal">
$ cat /var/vcap/store/containers/16iod87tbpe/run/wshd.pid
2398
$ pstree -p 2398
wshd(2398)───bash(2457)───mongod(2459)─┬─proxyctl(2470)─┬─{proxyctl}(2472)
                                       │                ├─{proxyctl}(2473)
                                       │                ├─{proxyctl}(2474)
                                       │                └─{proxyctl}(2475)
                                       ├─{mongod}(2497)
                                       ├─{mongod}(2499)
                                       ├─{mongod}(2500)
                                       ├─{mongod}(2501)
                                       ├─{mongod}(2502)
                                       ├─{mongod}(2503)
                                       ├─{mongod}(2504)
                                       └─{mongod}(2505)
</pre>

<h3><a id="services-rabbit"></a>RabbitMQ daylimit daemon</h3>

<p>RabbitMQ has a daylimit daemon to monitor the bandwidth outside Warden container (monitored by monit) and it will take care of the bandwidth of each RabbitMQ instance. A RabbitMQ instance will be able to work without the daylimit daemon, while the daylimit daemon will block an instance when the throughput reaches its day limit.</p>

          </div><!-- End of content_inner -->
        </div><!-- End of container-full -->
      </div><!-- End of content -->
    </div><!-- End of non_footer -->
    <div id='footer'>
      <div id='container-footer'>
        <div class='bg_social'>
          <ul class='social'>
            <li>
            <a href='http://twitter.com/cloudfoundry' target='_blank'>
            <img alt='Twitter' src='/images/twitter_large.png'>
            </a>
            </li>
            <li>
            <a href='https://plus.google.com/114245065906861739918/posts' target='_blank'>
            <img alt='Google+' src='/images/g+_large.png'>
            </a>
            </li>
            <li>
            <a href='http://facebook.com/cloudfoundry' target='_blank'>
            <img alt='Facebook' src='/images/facebook_large.png'>
            </a>
            </li>
            <li>
            <a href='http://youtube.com/cloudfoundry' target='_blank'>
            <img alt='Youtube' src='/images/youtube_large.png'>
            </a>
            </li>
          </ul>
        </div><!-- End of bg_social -->
        <ul class='links'>
          <li>
          <a href='http://www.cloudfoundry.com/about'>About</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://blog.cloudfoundry.com/'>Blog</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/partners'>Partners</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://docs.cloudfoundry.com'>Docs</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/faq'>FAQ</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/getinvolved'>Get Involved</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://status.cloudfoundry.com/'>Status</a>
          </li>
          <li class='disc'>•</li>
          <li>
          <a href='http://www.cloudfoundry.com/support'>Support</a>
          </li>
        </ul>
        <div class='copyright'>
          <div class='hr-horizontal-dark'></div>
          <br>
          <p>
            &copy;
            <script>
              //<![CDATA[
                var d = new Date();
                document.write(d.getFullYear());
              //]]>
            </script>
            GoPivotal, Inc. All rights reserved.
            <a href='http://www.cloudfoundry.com/terms'>Terms</a>
            <a href='http://www.gopivotal.com/privacy-policy' target='_blank'>Privacy</a>
          </p>
        </div><!-- End of copyright -->
      </div><!-- End of container-footer -->
    </div><!-- End of footer -->
    <script type="text/javascript">
      (function() {
        var didInit = false;
        function initMunchkin() {
          if(didInit === false) {
            didInit = true;
            Munchkin.init('625-IUJ-009');
          }
        }
        var s = document.createElement('script');
        s.type = 'text/javascript';
        s.async = true;
        s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
        s.onreadystatechange = function() {
          if (this.readyState == 'complete' || this.readyState == 'loaded') {
            initMunchkin();
          }
        };
        s.onload = initMunchkin;
        document.getElementsByTagName('head')[0].appendChild(s);
      })();
    </script>
  </body>
</html>
